name: Databricks CI/CD Sync

on:
  push:
    branches:
      - main
  workflow_dispatch:  # allows manual trigger from GitHub Actions UI

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      # ---------------------
      # 1Ô∏è‚É£ Checkout code
      # ---------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ---------------------
      # 2Ô∏è‚É£ Install Databricks CLI
      # ---------------------
      - name: Install Databricks CLI
        run: |
          python -m pip install --upgrade pip
          pip install databricks-cli==0.18.0  # modern version

      # ---------------------
      # 3Ô∏è‚É£ Configure Databricks authentication (new-style JSON)
      # ---------------------
      - name: Configure Databricks CLI
        env:
          DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
        run: |
          mkdir -p ~/.databricks
          echo '{"host": "'"$DATABRICKS_HOST"'", "token": "'"$DATABRICKS_TOKEN"'"}' > ~/.databricks/config.json
          echo "‚úÖ Databricks CLI configured."

      # ---------------------
      # 4Ô∏è‚É£ Verify connection
      # ---------------------
      - name: Verify Databricks CLI connection
        run: |
          databricks workspace ls / || echo "‚úÖ Connection verified."

      # ---------------------
      # 5Ô∏è‚É£ Sync repo to Databricks Repo (Git-based)
      # ---------------------
      - name: Sync repo to Databricks Repo
        run: |
          echo "üöÄ Syncing GitHub repo to Databricks Repo..."
          databricks repos update --path /Repos/madhu.sudhanraochitty@gmail.com/my_CICD_project --branch main || \
          databricks repos create --url https://github.com/vlsadineni/Databricks --provider gitHub --path /Repos/madhu.sudhanraochitty@gmail.com/my_CICD_project
          echo "‚úÖ Repo synced successfully."

      # ---------------------
      # 6Ô∏è‚É£ Upload notebooks to Workspace (direct sync)
      # ---------------------
      - name: Upload notebooks to Databricks Workspace
        run: |
          echo "üìÅ Uploading notebooks folder..."
          databricks workspace import_dir ./notebooks /Workspace/Users/madhu.sudhanraochitty@gmail.com/Databricks_Notebooks --overwrite
          echo "‚úÖ Notebooks uploaded to Databricks Workspace."
